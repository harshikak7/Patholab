<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="payment.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Payment</title>
    <style>
        .validation-suggestion {
            color: red;
            font-size: 12px;
            display: none;
            margin-top: 5px;
        }
        .icon-relative {
            position: relative;
        }
        .input {
            padding-right: 30px;
        }
        .cart-item {
            margin-bottom: 10px;
        }
        .remove-btn {
            margin-left: 10px;
            color: rgb(226, 71, 71);
            cursor: pointer;
            align-items:flex-end;
        }
    </style>
</head>
<body>
    <div class="container-pay">
        <div class="bgimg"><img src="credit img.jpeg" alt="Credit Card Image"></div>
        <div class="wrapper">
            <div class="payment">
                <h2>Payment Gateway</h2>
                <div class="form">
                    <div class="pay-card space icon-relative">
                        <label class="label">Card Holder:</label>
                        <input type="text" class="input" name="card_holder" placeholder="Card Holder Name" required>
                        <i class="fa-solid fa-user"></i>
                        <div class="validation-suggestion" id="name-suggestion">⚠️ At least 3 letters.</div>
                    </div>

                    <div class="pay-card space icon-relative">
                        <label class="label">Card Number:</label>
                        <input type="text" class="input" name="card_number" placeholder="0000 0000 0000 0000" required>
                        <i class="fa-regular fa-credit-card"></i>
                        <div class="validation-suggestion" id="card-suggestion">⚠️ Must be 16 digits.</div>
                    </div>

                    <div class="card-grp space">
                        <div class="card-item icon-relative">
                            <label class="label">Expiry Date:</label>
                            <input type="text" class="input" name="expiry_date" placeholder="MM/YY" required>
                            <i class="fa-regular fa-calendar"></i>
                            <div class="validation-suggestion" id="expiry-suggestion">⚠️ Enter valid date.</div>
                        </div>

                        <div class="card-item icon-relative">
                            <label class="label">CVC:</label>
                            <input type="password" class="input" name="CVC" placeholder="000" maxlength="3" required>
                            <i class="fa-solid fa-lock"></i>
                            <div class="validation-suggestion" id="cvc-suggestion">⚠️ 3 digits required.</div>
                        </div>
                    </div>

                    <div class="pay-btn">
                        <p><strong>Tests Selected:</strong></p>
                        <div id="selected-tests"></div>
                        <p><strong>Total Amount:</strong> <span id="payment-total">₹0.00</span></p>
                    </div>

                    <div class="payment-btn">
                        <button class="pay1">Pay Now</button>
                        <button class="pay2" onclick="location.href='test.html'">Go Back</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function () {
        // Input masks
        $('input[name="card_number"]').mask('0000 0000 0000 0000');
        $('input[name="expiry_date"]').mask('00/00');
        $('input[name="CVC"]').mask('000');

        // Load cart from localStorage
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        // Display cart items
        const displayCart = () => {
            const cartDiv = $("#selected-tests");
            cartDiv.empty();

            if (cart.length === 0) {
                cartDiv.html('<p>Your cart is empty.</p>');
                $("#payment-total").text(`₹0.00`);
                return;
            }

            let totalPrice = 0;

            cart.forEach((item, index) => {
                totalPrice += item.price;
                cartDiv.append(`
                    <div class="cart-item">
                        ${escapeHtml(item.name)} - ₹${item.price}
                        <span class="remove-btn" onclick="removeFromCart(${index})">Remove</span>
                    </div>
                `);
            });

            $("#payment-total").text(`₹${totalPrice.toFixed(2)}`);
        };

        // Remove item from cart
        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            displayCart();
        };

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            return $('<div>').text(text).html();
        }

        // Validate fields on Pay Now
        function validateForm() {
            let valid = true;

            const cardHolder = $('input[name="card_holder"]').val().trim();
            const cardNumber = $('input[name="card_number"]').val().replace(/\s/g, '');
            const expiryDate = $('input[name="expiry_date"]').val();
            const cvc = $('input[name="CVC"]').val();

            // Validate Card Holder
            if (!/^[a-zA-Z\s]{3,}$/.test(cardHolder)) {
                $('#name-suggestion').show();
                valid = false;
            } else {
                $('#name-suggestion').hide();
            }

            // Validate Card Number
            if (cardNumber.length !== 16) {
                $('#card-suggestion').show();
                valid = false;
            } else {
                $('#card-suggestion').hide();
            }

            // Validate Expiry Date
            const parts = expiryDate.split('/');
            const expMonth = parseInt(parts[0]);
            const expYear = parseInt(parts[1]) + 2000;
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;

            if (parts.length !== 2 || expMonth < 1 || expMonth > 12 ||
                expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
                $('#expiry-suggestion').show();
                valid = false;
            } else {
                $('#expiry-suggestion').hide();
            }

            // Validate CVC
            if (cvc.length !== 3) {
                $('#cvc-suggestion').show();
                valid = false;
            } else {
                $('#cvc-suggestion').hide();
            }

            return valid;
        }

        // Pay Now functionality
        $('.pay1').click(function (event) {
    event.preventDefault();

    // Clear previous warnings
    $('.validation-suggestion').hide();

    if (!validateForm()) {
        Swal.fire("⚠️ Invalid Inputs", "Please correct the highlighted fields before proceeding.", "error");
        return;
    }

    if (cart.length === 0) {
        Swal.fire("⚠️ Cart Empty", "Please add tests before making a payment.", "warning");
        return;
    }

    const totalPrice = cart.reduce((sum, item) => sum + item.price, 0).toFixed(2);
    const cartDetails = cart.map(item => `${escapeHtml(item.name)} - ₹${item.price}`).join("<br>");

    Swal.fire({
        title: "⚠️ Confirm Payment",
        html: `<strong>Tests Selected:</strong><br>${cartDetails}<br><br><strong>Total Amount:</strong> ₹${totalPrice}`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, Pay Now",
        cancelButtonText: "Cancel"
    }).then((result) => {
        if (result.isConfirmed) {
            // Store payment details in localStorage for appointments page
            const paymentDetails = {
                tests: cart,
                totalAmount: totalPrice,
                date: new Date().toLocaleString(),
                status: 'Paid'
            };
            localStorage.setItem("paymentDetails", JSON.stringify(paymentDetails));

            // Clear cart and redirect to appointments page
            localStorage.removeItem("cart");
            Swal.fire({
                title: "✅ Payment Successful!",
                text: `Your payment of ₹${totalPrice} has been processed.`,
                icon: "success",
                confirmButtonText: "OK"
            }).then(() => {
                window.location.href = "home.html"; // Redirect to appointments page
            });
        } else {
            Swal.fire("❌ Payment Cancelled", "Your payment was not processed.", "info");
        }
    });
});

        // Initial display
        displayCart();
    });
    </script>
</body>
</html>